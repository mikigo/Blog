import{_ as s,c as a,R as t,o as n}from"./chunks/framework.CpY5Ih_Y.js";const h="/blog/wayland%E9%94%AE%E9%BC%A0%E6%A8%A1%E6%8B%9F%E5%B7%A5%E5%85%B7%E6%8A%80%E6%9C%AF%E8%B0%83%E7%A0%94_assets/%E5%BD%93%E5%89%8D%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88.png",l="/blog/wayland%E9%94%AE%E9%BC%A0%E6%A8%A1%E6%8B%9F%E5%B7%A5%E5%85%B7%E6%8A%80%E6%9C%AF%E8%B0%83%E7%A0%94_assets/%E5%B7%A5%E5%85%B7%E7%BB%93%E6%9E%84.png",k="/blog/wayland%E9%94%AE%E9%BC%A0%E6%A8%A1%E6%8B%9F%E5%B7%A5%E5%85%B7%E6%8A%80%E6%9C%AF%E8%B0%83%E7%A0%94_assets/%E6%BC%94%E8%BF%9B%E6%96%B9%E6%A1%88.png",F=JSON.parse('{"title":"Wayland键鼠模拟工具技术调研","description":"","frontmatter":{"Author":"有志"},"headers":[],"relativePath":"技术文档/技术调研/wayland键鼠模拟工具技术调研.md","filePath":"技术文档/技术调研/wayland键鼠模拟工具技术调研.md","lastUpdated":1737267928000}'),p={name:"技术文档/技术调研/wayland键鼠模拟工具技术调研.md"};function e(E,i,r,d,y,g){return n(),a("div",null,i[0]||(i[0]=[t('<h1 id="wayland键鼠模拟工具技术调研" tabindex="-1">Wayland键鼠模拟工具技术调研 <a class="header-anchor" href="#wayland键鼠模拟工具技术调研" aria-label="Permalink to &quot;Wayland键鼠模拟工具技术调研&quot;">​</a></h1><h2 id="_1、问题" tabindex="-1">1、问题 <a class="header-anchor" href="#_1、问题" aria-label="Permalink to &quot;1、问题&quot;">​</a></h2><p>目前Wayland环境下没有一个相对完美的键鼠模拟工具，我们希望实现一个键鼠模拟工具，需要具备以下功能点。</p><ol><li>模拟键盘鼠标的动作</li><li>获取光标位置</li><li>需要能便捷输入中文文字</li></ol><h2 id="_2、术语定义" tabindex="-1">2、术语定义 <a class="header-anchor" href="#_2、术语定义" aria-label="Permalink to &quot;2、术语定义&quot;">​</a></h2><table><thead><tr><th style="text-align:center;"><strong>序号</strong></th><th style="text-align:center;"><strong>术语</strong></th><th style="text-align:left;"><strong>定义</strong></th></tr></thead><tbody><tr><td style="text-align:center;">1</td><td style="text-align:center;">uinput</td><td style="text-align:left;">在内核中模拟一个输入设备，模拟输入操作</td></tr><tr><td style="text-align:center;">2</td><td style="text-align:center;">KWayland</td><td style="text-align:left;">一个 Wayland 下支持操控键鼠的库</td></tr><tr><td style="text-align:center;">3</td><td style="text-align:center;">X11</td><td style="text-align:left;">一种显示服务器协议，linux 系统上广泛使用。</td></tr><tr><td style="text-align:center;">4</td><td style="text-align:center;">Wayland</td><td style="text-align:left;">一种显示服务器协议，旨在替代 X11。</td></tr></tbody></table><h2 id="_3、键鼠模拟操控现状" tabindex="-1">3、键鼠模拟操控现状 <a class="header-anchor" href="#_3、键鼠模拟操控现状" aria-label="Permalink to &quot;3、键鼠模拟操控现状&quot;">​</a></h2><h3 id="_3-1、uinput" tabindex="-1">3.1、uinput <a class="header-anchor" href="#_3-1、uinput" aria-label="Permalink to &quot;3.1、uinput&quot;">​</a></h3><p>uinput（User Input）是 Linux 内核提供的一个框架，用于模拟用户输入设备，例如键盘、鼠标和游戏手柄等。通过 uinput，用户空间程序可以创建虚拟输入设备，并模拟各种输入事件，从而实现对键鼠操控的模拟。</p><p><strong>优点</strong></p><p>原生支持： uinput 是 Linux 内核的一部分，原生支持在 Linux 系统上模拟用户输入设备，不需要额外安装软件包。</p><p>灵活性： 用户空间程序可以根据需要创建不同类型的虚拟输入设备，并模拟各种输入事件，包括按键、鼠标移动、点击等，灵活性很高。</p><p>与系统集成： uinput 可以很好地与系统集成，可以与 X11、Wayland 等窗口系统无缝配合，实现对图形界面的模拟操控。</p><p>适用性广泛： 由于 uinput 是 Linux 内核的一部分，因此适用于各种基于 Linux 内核的操作系统和嵌入式设备。</p><p><strong>缺点</strong></p><p>权限管理： 使用 uinput 需要对设备文件 /dev/uinput 具有适当的权限，通常需要 root 或者具有相应权限的用户才能够操作。</p><p>编程复杂性： 虽然 uinput 提供了丰富的功能，但是使用起来相对复杂，需要深入理解 Linux 输入系统和相关接口的工作原理。</p><p>依赖性： uinput 依赖于 Linux 内核和相应的驱动程序，因此在某些嵌入式系统或者特定配置下可能无法使用。</p><h3 id="_3-2、kwayland" tabindex="-1">3.2、KWayland <a class="header-anchor" href="#_3-2、kwayland" aria-label="Permalink to &quot;3.2、KWayland&quot;">​</a></h3><p>KWayland 是 KDE 社区开发的一个库，用于在 Wayland 显示服务器和客户端之间进行通信。它提供了用于构建 Wayland 协议的 C++ API，使开发者能够轻松地创建 Wayland 客户端和服务器端应用程序。</p><p><strong>优点</strong></p><p>原生支持 Wayland 协议： KWayland 提供了原生的 Wayland 协议支持，允许您在 Wayland 显示服务器和客户端之间进行通信，从而实现对键盘和鼠标的模拟操控。</p><p>功能丰富： KWayland 提供了丰富的功能，包括处理输入设备事件、管理窗口、渲染和图形处理等，使得模拟键鼠操控变得更加容易和灵活。</p><p>跨平台性： KWayland 是基于 Qt 框架的，因此具有良好的跨平台性，能够在各种支持 Qt 的操作系统上运行。</p><p>社区支持： 作为 KDE 社区的一部分，KWayland 受到了活跃的社区支持和持续的更新，可以获得及时的修复和改进。</p><p><strong>缺点</strong></p><p>依赖性： 使用 KWayland 需要依赖于 Qt 和 KF5（KDE Frameworks 5），因此需要确保系统中安装了这些依赖项。</p><p>性能开销： 在某些情况下，使用 KWayland 进行模拟键鼠操控可能会带来一定的性能开销，特别是在处理大量事件时可能会影响系统性能。</p><h2 id="_4、获取光标位置现状" tabindex="-1">4、获取光标位置现状 <a class="header-anchor" href="#_4、获取光标位置现状" aria-label="Permalink to &quot;4、获取光标位置现状&quot;">​</a></h2><h3 id="_4-1、uinput" tabindex="-1">4.1、uinput <a class="header-anchor" href="#_4-1、uinput" aria-label="Permalink to &quot;4.1、uinput&quot;">​</a></h3><p>虽然 uinput 允许创建和注入输入事件，但它不直接提供获取光标位置的功能。获取光标位置通常需要访问系统中的显示服务器的状态。</p><h3 id="_4-2、kwayland" tabindex="-1">4.2、KWayland <a class="header-anchor" href="#_4-2、kwayland" aria-label="Permalink to &quot;4.2、KWayland&quot;">​</a></h3><p>在使用 KWayland 时，无法通过编译后的库直接获取光标位置，Wayland 与 X11 不同，在设计上更加注重安全和简洁，因此直接获取全局光标位置的能力被限制了。为了实现这个功能，需要在 KWayland 的源代码中进行自定义修改，这个很考验对 KWayland 源代码和Wayland协议熟悉与理解。</p><h2 id="_5、模拟文字输入现状" tabindex="-1">5、模拟文字输入现状 <a class="header-anchor" href="#_5、模拟文字输入现状" aria-label="Permalink to &quot;5、模拟文字输入现状&quot;">​</a></h2><h3 id="_5-1、自定义实现输入法" tabindex="-1">5.1、自定义实现输入法 <a class="header-anchor" href="#_5-1、自定义实现输入法" aria-label="Permalink to &quot;5.1、自定义实现输入法&quot;">​</a></h3><p>自定义实现一个输入法，这样就可以达到输入各种文字的目的，但这涉及多个方面，包括输入法引擎的设计、用户界面的实现、系统集成。linux 有 3 大输入法框架，工作量大，有难度，通过选择适当的输入法框架、合理的设计和优化，可以实现一个功能丰富、性能优良的输入法。</p><h3 id="_5-2、通过剪贴板输入文字" tabindex="-1">5.2、通过剪贴板输入文字 <a class="header-anchor" href="#_5-2、通过剪贴板输入文字" aria-label="Permalink to &quot;5.2、通过剪贴板输入文字&quot;">​</a></h3><p>在 Wayland 下，由于其设计初衷是更加注重安全性和隐私，限制了应用程序直接访问全局剪贴板的能力。这与 X11 不同，后者允许应用程序直接访问和操作剪贴板。在 Wayland 中，剪贴板的访问和操作通常由合成器（compositor）管理，这使得直接写入剪贴板变得更为困难。然而，通过正确的 API 和协议，仍然可以实现这一功能。</p><p>在 Wayland 下，剪贴板操作主要通过 wl_data_device_manager 和 wl_data_source 接口来实现。应用程序不能直接访问全局剪贴板，但可以在合成器允许的情况下进行剪贴板内容的设置和读取。并且由于正常 Wayland 系统为兼用 X11 显示协议，通常存在 XWayland 服务，这使得直接使用 X11 剪贴版写入工具也可完成剪贴板写入操作。</p><h2 id="_6、整体方案" tabindex="-1">6、整体方案 <a class="header-anchor" href="#_6、整体方案" aria-label="Permalink to &quot;6、整体方案&quot;">​</a></h2><h3 id="_6-1、工具设计" tabindex="-1">6.1、工具设计 <a class="header-anchor" href="#_6-1、工具设计" aria-label="Permalink to &quot;6.1、工具设计&quot;">​</a></h3><p><strong>使用 uinput 模拟键鼠输入 + 光标获取</strong></p><p>优点: 直接访问内核输入子系统，提供较低延迟和高精度的输入模拟。</p><p>适用场景: 需要精确模拟键鼠操作的应用，适用于所有支持 uinput 的 Linux 系统。</p><p><strong>通过剪贴板实现中文输入</strong></p><p>优点: 简单实现，通过剪贴板操作进行文本输入。</p><p>难点: Wayland 环境下实现困难，由于安全性限制，可能影响用户体验。</p><p>适用场景: 较低频率的文本输入，或者需要快速实现的原型系统。</p><p><img src="'+h+'" alt="架构" title="架构"></p><p>​ 图1</p><p>具体工具结构，采用经典 CS 结构，Python 包负责封装调用接口，Wdotoold 负责实现具体各个功能单元。</p><p><img src="'+l+`" alt=""></p><p>​ 图2</p><h3 id="_6-2、工具实现" tabindex="-1">6.2、工具实现 <a class="header-anchor" href="#_6-2、工具实现" aria-label="Permalink to &quot;6.2、工具实现&quot;">​</a></h3><p><strong>uinput 初始化实现</strong></p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//创建并设置设备</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> setup\\_uinput\\</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">_device</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Info info) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uinput</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\\_setup usetup;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> open</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/dev/uinput&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, O\\_WRONLY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> O\\_NONBLOCK);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (fd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">perror</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Unable to open /dev/uinput&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fd;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//激活同步事件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fd, UI\\_SET\\_EVBIT, EV\\_SYN), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;UI</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SET</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EVBIT EV</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SYN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//设置支持鼠标左右中键</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fd, UI\\_SET\\_EVBIT, EV\\_KEY), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;UI</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SET</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EVBIT, EV</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">KEY&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> key\\_list[] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {KEY\\_ESC};</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key\\_list)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fd, UI\\_SET\\_KEYBIT, key\\_list[i]), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;UI</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SET</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">KEYBIT LIST&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//设置支持滚轮事件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fd, UI\\_SET\\_EVBIT, EV\\_REL), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;UI</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SET</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EVBIT, EV</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">REL&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fd, UI\\_SET\\_RELBIT, REL\\_WHEEL), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;UI</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SET</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">RELBIT, REL</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">WHEEL&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//设置支持绝对坐标事件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fd, UI\\_SET\\_EVBIT, EV\\_ABS), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;UI</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SET</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EVBIT EV</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ABS&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fd, UI\\_SET\\_ABSBIT, ABS\\_X), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;UI</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SETEVBIT ABS</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">X&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fd, UI\\_SET\\_ABSBIT, ABS\\_Y), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;UI</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SETEVBIT ABS</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Y&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//设置虚拟设备版本信息</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uinput</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\\_setup uidev;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">memset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">uidev, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(uidev));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">snprintf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(uidev.name, UINPUT\\_MAX\\_NAME\\_SIZE, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;wdotool&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">uidev.id.bustype </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BUS\\_I2C;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">uidev.id.vendor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> 0x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">04f3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // wacom</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">uidev.id.product </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> 0x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2841</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">uidev.id.version </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> 0x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">uidev.ff\\_effects\\_max </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fd, UI\\_DEV\\_SETUP, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">uidev), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;UI</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">DEV</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SETUP&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//设置绝对坐标事件依赖的屏幕分辨率信息</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uinput</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\\_abs\\_setup xabs;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">xabs.code </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ABS\\_X;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">xabs.absinfo.minimum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">xabs.absinfo.maximum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> info.screen\\_width;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">xabs.absinfo.fuzz </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">xabs.absinfo.flat </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">xabs.absinfo.resolution </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> info.resolution;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">xabs.absinfo.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uinput</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\\_abs\\_setup yabs;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">yabs.code </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ABS\\_Y;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">yabs.absinfo.minimum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">yabs.absinfo.maximum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> info.screen\\_height;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">yabs.absinfo.fuzz </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">yabs.absinfo.flat </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">yabs.absinfo.resolution </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> info.resolution;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">yabs.absinfo.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fd, UI\\_ABS\\_SETUP, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">xabs), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ABS</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">X setup&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fd, UI\\_ABS\\_SETUP, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">yabs), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ABS</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Y setup&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//创建设备</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fd, UI\\_DEV\\_CREATE), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;device creation&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>剪贴板写入实现</strong></p><p>由于 uos 存在 Xwayland 服务，目前使用 wl-clipboard 实现剪贴板写入功能。</p><p><strong>代码孵化仓库</strong></p><p><a href="https://github.com/funny-dream/wdotool.git" target="_blank" rel="noreferrer">https://github.com/funny-dream/wdotool.git</a></p><h2 id="_7、小结" tabindex="-1">7、小结 <a class="header-anchor" href="#_7、小结" aria-label="Permalink to &quot;7、小结&quot;">​</a></h2><h3 id="_7-1、现有方案总结" tabindex="-1">7.1、现有方案总结 <a class="header-anchor" href="#_7-1、现有方案总结" aria-label="Permalink to &quot;7.1、现有方案总结&quot;">​</a></h3><p>总体实现一个模拟键鼠操作的工具，主要功能包括键鼠操控、光标位置获取和中文输入。</p><h3 id="_7-2、后续演进" tabindex="-1">7.2、后续演进 <a class="header-anchor" href="#_7-2、后续演进" aria-label="Permalink to &quot;7.2、后续演进&quot;">​</a></h3><p>考虑兼容各种系统，后续将使用配置文件依据实际系统是否支持，按下图中 Wdotool 服务端单元组件功能进行组合配置，使用 KWayland + uinput 实现键鼠模拟和光标获取，使用剪贴板 + 自定义输入法实现中文输入。</p><p><strong>KWayland 实现键鼠模拟和光标获取</strong></p><p>优点: 通过 Wayland 协议实现，适用于使用 Wayland 显示服务器的系统。</p><p>适用场景: 运行在 Wayland 环境下的应用，需要与 Wayland 合成器协作的场景。</p><p>工具提供多套配置方案，以适应不同的使用场景和平台需求。</p><p><strong>自定义输入法实现中文输入</strong></p><p>优点: 提供灵活性和可定制性，可以根据特定需求设计输入法逻辑。</p><p>适用场景: 需要特定功能或行为的输入法，适用于 IBus 或 Fcitx 框架。</p><p><img src="`+k+'" alt="图3" title="图3"></p><h2 id="_8、参考资料" tabindex="-1">8、参考资料 <a class="header-anchor" href="#_8、参考资料" aria-label="Permalink to &quot;8、参考资料&quot;">​</a></h2><ol><li><a href="https://www.kernel.org/doc/html/latest/input/uinput.html" target="_blank" rel="noreferrer">https://www.kernel.org/doc/html/latest/input/uinput.html</a></li><li><a href="https://github.com/KDE/kwayland" target="_blank" rel="noreferrer">https://github.com/KDE/kwayland</a></li><li><a href="https://github.com/fcitx/fcitx5" target="_blank" rel="noreferrer">https://github.com/fcitx/fcitx5</a></li><li><a href="https://github.com/phuang/ibus" target="_blank" rel="noreferrer">https://github.com/phuang/ibus</a></li></ol>',75)]))}const c=s(p,[["render",e]]);export{F as __pageData,c as default};
