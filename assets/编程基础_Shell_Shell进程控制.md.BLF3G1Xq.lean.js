import{_ as e,C as t,c as k,o as d,R as n,m as i,a,G as p,w as h}from"./chunks/framework.ButFe1M8.js";const u=JSON.parse('{"title":"Shell进程调用","description":"","frontmatter":{"Author":"海针 - 搬运"},"headers":[],"relativePath":"编程基础/Shell/Shell进程控制.md","filePath":"编程基础/Shell/Shell进程控制.md","lastUpdated":1740102501000}'),r={name:"编程基础/Shell/Shell进程控制.md"};function F(o,s,c,g,E,y){const l=t("font");return d(),k("div",null,[s[22]||(s[22]=n(`<h1 id="shell进程调用" tabindex="-1">Shell进程调用 <a class="header-anchor" href="#shell进程调用" aria-label="Permalink to &quot;Shell进程调用&quot;">​</a></h1><h2 id="_1-进程调用无处不在" tabindex="-1">1. 进程调用无处不在 <a class="header-anchor" href="#_1-进程调用无处不在" aria-label="Permalink to &quot;1. 进程调用无处不在&quot;">​</a></h2><p>实际上，Shell脚本的进程调用无处不在，除了shell自身的内建命令，Shell调用工具命令都会开辟一个子进程去执行，比如在shell脚本中使用sed，grep，sleep等命令。</p><p><code>test@test-PC:~$ vim proc.sh</code></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;fork a sleep process.&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span></code></pre></div><p>如上例，在Bash脚本中执行一个sleep， 执行脚本，新开终端查询进程。查询结果分析可以看到，sleep 20做为一个子进程在运行，进程ID为<code>14586</code>,而他的父进程正是proc.sh脚本进程，ID为<code>14586</code>。</p><p><code>test@test-PC:~$ bash proc.sh</code><br><code>test@test-PC:~$ ps -ef | grep -E &#39;sleep|proc.sh&#39;</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>fenglg   14586  9358  0 09:33 pts/0    00:00:00 bash proc.sh</span></span>
<span class="line"><span>fenglg   14587 14586  0 09:33 pts/0    00:00:00 sleep 20</span></span>
<span class="line"><span>fenglg   14634 25734  0 09:34 pts/1    00:00:00 grep -E sleep|proc.sh</span></span></code></pre></div><h2 id="_2-脚本的调用" tabindex="-1">2. 脚本的调用 <a class="header-anchor" href="#_2-脚本的调用" aria-label="Permalink to &quot;2. 脚本的调用&quot;">​</a></h2><ul><li><p>调用方法1： <code>bash script.sh</code><br> 在当前Shell中开辟一个子进程shell运行script.sh脚本， 与父进程共享环境变量；script.sh文件可不必有可执行权限，已经显示的给出调用script.sh的解析器为Bash。</p></li><li><p>调用方法2：<code>./script.sh</code><br> 在当前Shell中开辟一个子进程shell运行script.sh脚本， 与父进程共享环境变量；script.sh文件必须有可执行权限，否则权限错误，使用哪种shell解释执行，取决于脚本开头的声明，如<code>#!/bin/bash</code>，如未进行声明，默认使用当前终端所用Shell。</p></li><li><p>调用方法3： <code>. script.sh</code><br> 在当前Shell进程中执行script.sh，与当前shell同一进程，共享全局变量和环境变量。script.sh如有exit，则退出当前shell。</p></li><li><p>调用方法4： <code>source script.sh</code><br> 同调用方法3</p><p><strong>补充说明</strong></p><blockquote><ol><li>调用方法1,2 都是新开shell进程执行， 调用方法3,4都是当前进程中执行；</li><li>调用方法3,4的常用场景在需要导入环境变量，全局变量，或者导入公共函数处理脚本时使用，使用<code>.</code>和使用<code>source</code>效果是一样的，但source是Bash的内建命令，并非所有Shell解析器都能支持，所以从脚本的健壮性和通用性角度讲，推荐使用<code>.</code>。</li></ol></blockquote></li></ul><h2 id="_3-进程的后台处理" tabindex="-1">3. 进程的后台处理 <a class="header-anchor" href="#_3-进程的后台处理" aria-label="Permalink to &quot;3. 进程的后台处理&quot;">​</a></h2><h3 id="_3-1-进程后台运行" tabindex="-1">3.1 进程后台运行 <a class="header-anchor" href="#_3-1-进程后台运行" aria-label="Permalink to &quot;3.1 进程后台运行&quot;">​</a></h3>`,12)),i("ul",null,[s[10]||(s[10]=n(`<li><code>&amp;</code>： 使用<code>&amp;</code>符号，在调用进程或者函数后加 <code>&amp;</code>，即将进程放到后台去执行。如下，<code>sleep</code>进程被放入后台，进程ID为<code>13358</code>。<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/code/cli$ sleep 30 &amp;</span></span>
<span class="line"><span>[1] 13358</span></span></code></pre></div></li>`,1)),i("li",null,[s[1]||(s[1]=i("code",null,"Ctrl",-1)),s[2]||(s[2]=a("+")),s[3]||(s[3]=i("code",null,"z",-1)),s[4]||(s[4]=a("： 如果是在终端中调用的命令或脚本，可以通过键入")),s[5]||(s[5]=i("code",null,"Ctrl",-1)),s[6]||(s[6]=a("+")),s[7]||(s[7]=i("code",null,"z",-1)),s[8]||(s[8]=a("，将命令或脚本放入后并挂起进程，")),p(l,{color:"red"},{default:h(()=>s[0]||(s[0]=[a("注意：进程在后台不再运行，是停止状态，等待唤醒指令后才能继续运行")])),_:1}),s[9]||(s[9]=n(`。<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/code/cli$ sleep 20 </span></span>
<span class="line"><span>^Z</span></span>
<span class="line"><span>[1]+  已停止               sleep 20</span></span></code></pre></div>`,2))])]),s[23]||(s[23]=n(`<h3 id="_3-2-查询后台进程" tabindex="-1">3.2 查询后台进程 <a class="header-anchor" href="#_3-2-查询后台进程" aria-label="Permalink to &quot;3.2 查询后台进程&quot;">​</a></h3><p><code>jobs</code>:使用<code>jobs</code>命令后台运行中的进程。<code>[1]</code> 中括号里的数字表示进程的作业号，唤醒和恢复时可以指定进程。<code>+</code>代表当前进程，<code>-</code>代表当前进程的上一进程，使用<code>fg</code>恢复时如不指定作业号，默认恢复当前进程。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/code/cli$ jobs</span></span>
<span class="line"><span>[1]+  已停止               sleep 20</span></span>
<span class="line"><span>[2]-  运行中               sleep 30 &amp;</span></span></code></pre></div><p><code>jobs</code>支持参数选项来对后台进程进行筛选。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>jobs [-lnprs]</span></span>
<span class="line"><span>     -l     普通信息之外，列出进程ID。</span></span>
<span class="line"><span>     -p     只列出作业的进程组 leader 的进程ID。</span></span>
<span class="line"><span>     -n     只显示从上次用户得知它们的状态之后，状态发生改变的作业的信息。</span></span>
<span class="line"><span>     -r     限制只输出正在运行的作业。</span></span>
<span class="line"><span>     -s     限制只输出停止的作业。</span></span></code></pre></div><h3 id="_3-3-恢复后台进程" tabindex="-1">3.3 恢复后台进程 <a class="header-anchor" href="#_3-3-恢复后台进程" aria-label="Permalink to &quot;3.3 恢复后台进程&quot;">​</a></h3><ul><li><p><code>fg</code>:将后台进程恢复到前台运行, 通过<code>fg number</code>指定进程作业号来恢复指定进程。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/code/cli$ fg 2</span></span>
<span class="line"><span>sleep 30</span></span></code></pre></div></li><li><p><code>bg</code>:将后台进程唤醒，继续在后台执行,即将挂起的任务进程的状态由 stopped 改为 running。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/code/cli$ bg 1</span></span>
<span class="line"><span>[1]+ sleep 20 &amp;</span></span>
<span class="line"><span>test@test-PC:~/work/code/cli$ jobs</span></span>
<span class="line"><span>[1]+  运行中               sleep 20 &amp;</span></span>
<span class="line"><span>test@test-PC:~/work/code/cli$</span></span></code></pre></div></li></ul><h2 id="_4-守护进程" tabindex="-1">4. 守护进程 <a class="header-anchor" href="#_4-守护进程" aria-label="Permalink to &quot;4. 守护进程&quot;">​</a></h2><p>通常我们运行脚本或者命令是在一个用户终端下，不论脚本是在前后还是后台运行，当我们关闭终端，脚本和命令进程也会随之消亡。这是因为终端退出时会对终端下的子shell进程发送<code>SIGHUP</code>信号，子进程shell进程收到信号默认终止进程运行。</p><p>有时这并不是我们想要的，比如写一个长时间运行的批处理脚本，如产品安装，升级，构建，脚本执行时长可能以小时来计算，在这期间如果终端异常中断，脚本也会中断，任务就会执行失败。</p><p>这里我们引入守护进程，借鉴了传统编程语言守护进程的概念（如C++/Java），Shell的守护进程可以狭义的理解为脱离了用户终端而在后台运行的进程。 实现方法如下：</p><ul><li><p><code>nohup script.sh &amp;</code> ： <code>nohup</code>通知脚本<code>script.sh</code>忽略掉终端断连信号<code>SIGHUP</code>，即终端断开时进程不会退出。如下，<code>sleep</code>进程放入后台，ID为<code>27310</code>。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/study/shell/share$ nohup sleep 800 &amp;</span></span>
<span class="line"><span>[1] 27310</span></span>
<span class="line"><span>test@test-PC:~/work/study/shell/share$ nohup: 忽略输入并把输出追加到&#39;nohup.out&#39;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>test@test-PC:~/work/study/shell/share$ jobs -l</span></span>
<span class="line"><span>[1]+ 27310 运行中               nohup sleep 800 &amp;</span></span>
<span class="line"><span>test@test-PC:~/work/study/shell/share$ </span></span>
<span class="line"><span>test@test-PC:~/work/study/shell/share$ ps -ef | grep sleep </span></span>
<span class="line"><span>fenglg   27310  9491  0 11:40 pts/1    00:00:00 sleep 800</span></span></code></pre></div><p>终端退出，再次登录查看<code>sleep</code>进程,进程ID<code>27310</code>仍然在运行，它已被 <code>init</code>进程(ID为<code>1</code>)接收。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~$ ps -ef | grep sleep</span></span>
<span class="line"><span>fenglg   27310     1  0 11:40 ?        00:00:00 sleep 800</span></span>
<span class="line"><span>fenglg   28176 28150  0 11:43 pts/1    00:00:00 grep sleep</span></span></code></pre></div></li><li><p>在脚本中忽略终端退出信号 改变进程接收<code>SIGHUP</code>信号后的默认处理方式，即主动捕捉信号并自定义处理方式。 在脚本中，需要开始忽略<code>SIGHUP</code>的核心代码运行之前，加入<code>trap &quot;&quot; HUP</code>， <code>&quot;&quot;</code>中可以自定义一个函数名，在接收到<code>SIGHUP</code>信号后执行该函数，也可以为空，不做任务处理，即忽略掉<code>SIGHUP</code>信号，程序照常运行。 <code>test@test-PC:~/work/study/shell/share$ vi sighup.sh</code></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2000</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">trap</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> HUP</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">main</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/study/shell/share$ bash sighup.sh  &amp;</span></span>
<span class="line"><span>[1] 1057</span></span>
<span class="line"><span>test@test-PC:~/work/study/shell/share$ ps -ef | grep sleep </span></span>
<span class="line"><span>fenglg    1058  1057  0 11:59 pts/4    00:00:00 sleep 2000</span></span></code></pre></div><p>重启终端，查看进程并未退出。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~$ ps -ef | grep sleep</span></span>
<span class="line"><span>fenglg    1058     1057  0 11:59 ?        00:00:00 sleep 2000</span></span></code></pre></div></li></ul><h2 id="_5-进程的并发控制" tabindex="-1">5. 进程的并发控制 <a class="header-anchor" href="#_5-进程的并发控制" aria-label="Permalink to &quot;5. 进程的并发控制&quot;">​</a></h2><h3 id="_5-1-一个简单的并发例子" tabindex="-1">5.1 一个简单的并发例子 <a class="header-anchor" href="#_5-1-一个简单的并发例子" aria-label="Permalink to &quot;5.1 一个简单的并发例子&quot;">​</a></h3><p>shell也可以通过进程并发的方式提高运行效果，以下是最简单的shell进程并发例子。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> child_process</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;I am a child process!&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main_process</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   child_process</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;I am a main process!&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">main_process</span></span></code></pre></div><p>以上是两个进程，主进程和子进程同时运行，各自打印自己的信息。 <code>child_process</code>子进程被放到了后台运行，主进程并没有等子进程运行完成就退出了。子进程在后台继续运行，直到退出。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/study/shell/share$ bash process.sh</span></span>
<span class="line"><span>I am a main process!</span></span>
<span class="line"><span>test@test-PC:~/work/study/shell/share$ I am a child process!</span></span></code></pre></div><h3 id="_5-2-shell进程的同步机制" tabindex="-1">5.2 Shell进程的同步机制 <a class="header-anchor" href="#_5-2-shell进程的同步机制" aria-label="Permalink to &quot;5.2 Shell进程的同步机制&quot;">​</a></h3><p>优化一下上述脚本，引入进程同步机制，主进程等待子进程执行完毕后再退出。这里引入<code>wait</code>命令。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> child_process</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]I am a child process,I quit!&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main_process</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   child_process</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   wait</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $!</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]I am a main process!I quit!&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">main_process</span></span></code></pre></div><p><code>$$</code>:当前shell的进程ID <code>$!</code>：最后一个运行在后台的进程ID 在父进程里使用<code>wait</code>以阻塞的方式等待子进程执行完毕，父进程（主进程）得以继续执行。这里值得注意的是不管父进程，还是子进程，打印PID都是<code>1161</code>，即当前shell进程的PID,这是bash的自身机制。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/study/shell/share$ bash process.sh </span></span>
<span class="line"><span>[1161]I am a child process,I quit!</span></span>
<span class="line"><span>[1161]I am a main process!I quit!</span></span></code></pre></div><h3 id="_5-3-多进程并发" tabindex="-1">5.3 多进程并发 <a class="header-anchor" href="#_5-3-多进程并发" aria-label="Permalink to &quot;5.3 多进程并发&quot;">​</a></h3><p>并发的目的是为了提高运行效率，以另外一种机制来实现多进程并发与同步。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">declare</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pidlist</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           #声明一个数组，用来收集子进程ID</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ((i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    sleep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> $((i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;         </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#将子进程交付后台执行</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    pidlist[$i]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$!</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           #将子进程ID(这里用$!表示最后一个后台进程ID)收集进数组</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;=Child process[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$!</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">] is running ...&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">done</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                      # 主进程无限循环监控子进程</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   pcount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\${</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pidlist[@]} &amp;&amp; [ \${pcount} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-le</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ] &amp;&amp; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">break</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  #如果数组为空，表示全部子进程已经退出。</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;+[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$pcount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]:[\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pidlist</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">[@]}] is running...&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pidlist</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">[@]}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">       kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${pid} &amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/dev/null   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用kill -0 监控子进程是否存在，如果不存在，则返回非0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$?</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -ne</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">           echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;-[\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pid</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}]child quit!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">           pidlist</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">( \${pidlist[@]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\${pid}</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} )    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#将已经退出的子进程ID清理出数组</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       fi</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   done</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">done</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;-[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]main process quit!&quot;</span></span></code></pre></div><ul><li>1）上面是用数组的方式采集进程ID，实现了5个子进程并发处理，子进程命令为<code>sleep</code>，这里根据业务需要可以替换成自定义的批处理进程，脚本，函数等；</li><li>2）这里进程间的同步是通过kill -0查询进程是否存在，查询的时长取决于执行时间最长的子进程。通过并发后脚本执行时长为5秒，如果串行则时长为15秒。</li></ul><h2 id="_6-进程间通信" tabindex="-1">6. 进程间通信 <a class="header-anchor" href="#_6-进程间通信" aria-label="Permalink to &quot;6. 进程间通信&quot;">​</a></h2><p>进程间通信（IPC，InterProcess Communication）是指在不同进程之间传播或交换信息。</p><p>编程语言常用的IPC的方式有管道（包括匿名管道和命名管道）、消息队列、信号量、共享内存等，如果涉及跨主机通信，可以使用Socket等。</p><p>当然Shell做为解释性语言无法直接实现上面的底层开发，这也不是我们使用Shell的初衷，但是我们仍然可以借助工具，借鉴思路实现简单的进程通信，以满足业务需要。</p><h3 id="_6-1-匿名管道" tabindex="-1">6.1 匿名管道 <a class="header-anchor" href="#_6-1-匿名管道" aria-label="Permalink to &quot;6.1 匿名管道&quot;">​</a></h3><p>匿名管道使用符号 <code>|</code> 表示,这是我们最常用的进程间通信方式了，管道左侧接收进程的标准输出，右侧是进程的标准输入。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>echo &quot;Name:Jack,Age:22,Gender:Man,Desc:null&quot; | cut -d&quot;,&quot; -f1 | sed &#39;s/Name://g&#39;</span></span></code></pre></div><p>如上例，一行代码我们使用了两个<code>|</code>，为了方便叙述我们称为管道1和管道2。 管道1左侧<code>echo</code>进程输出信息，原本是要送到标准输出（<code>STDOUT</code>）的,这里被管道1接收； 管道1右侧<code>cut</code>进程从管道1中读入信息，做出处理，然后输出到管道2；而<code>sed</code>进程又从从管道2中读入信息，做处理，将结果输出到标准输出。</p><p>注意：</p><ul><li><code>|</code>两侧是标准输出和标准输入，所以如果左侧是标准错误，是不会被送入管道，右侧也就无法接收处理。如下,<code>ls</code>的执行结果还是被送到了标准错误，在屏幕中显示，并没有进入管道。<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/study/shell/share$ ls &quot;not exist!&quot; | cut -d&quot;,&quot; -f1 | sed &#39;s/Name://g&#39; </span></span>
<span class="line"><span>ls: 无法访问&#39;not exist!&#39;: 没有那个文件或目录</span></span></code></pre></div></li></ul><h3 id="_6-2-命名管道" tabindex="-1">6.2 命名管道 <a class="header-anchor" href="#_6-2-命名管道" aria-label="Permalink to &quot;6.2 命名管道&quot;">​</a></h3><p><code>mkfifo</code>:用来创建命名管道，命名管道是一种特殊的文件，同一操作系统内的进程都可以向命名管道内写入消息，同理，也可以读取消息，消息写入和读取是双向的，跟普通文件一样，读写前提是进程要有权限。 如下是创建一个命名管道，权限标志位置第一个字母是<code>p</code>，代表这是管道文件（-：普通文件，d:目录文件，l:链接文件，b:设备文件，c:字符设备文件，p:管道文件），其它权限标志跟普通文件是一致的。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/study/shell/share$ mkfifo fifo</span></span>
<span class="line"><span>test@test-PC:~/work/study/shell/share$ ls -l</span></span>
<span class="line"><span>prw-r--r-- 1 fenglg fenglg    0 11月 20 10:21 fifo</span></span></code></pre></div><p>向管道写入信息,写入后会阻塞等待进程读取。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/study/shell/share$ echo &quot;Name:Jack,Age:22,Gender:Man,Desc:null&quot; &gt; fifo</span></span></code></pre></div><p>向管道读取信息，我们用<code>cat</code>命令，跟读取文件一样，如果管道内无消息，则阻塞等待消息进入管道。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/study/shell/share$ cat fifo</span></span>
<span class="line"><span>Name:Jack,Age:22,Gender:Man,Desc:null</span></span>
<span class="line"><span>test@test-PC:~/work/study/shell/share$</span></span></code></pre></div><p>读取信息完毕之后，<code>cat</code>进程退出，当然你也可以做后续的处理； 而写入进程<code>echo</code>在管道内信息被取走之后，进程也随之退出。</p>`,45)),i("p",null,[s[12]||(s[12]=a("可以看到，命名管道是通过阻塞的方式进行进程同步的，可以多个进程写入消息，读取进程按照 ")),i("strong",null,[p(l,{color:"Blue"},{default:h(()=>s[11]||(s[11]=[a("先进先出")])),_:1})]),s[13]||(s[13]=a(" 的顺序取走消息。可不可以多个进程读呢，当然也是可以的，但是消息被取走之后管道就空了（除非有新消息写入），多个进程来读，总是最先读取的进程拿到消息，后来读取的因为管道空了，只有阻塞等待，直到有新消息写入。"))]),s[24]||(s[24]=n(`<p>我们可以借助传统编程语言的思路做一个服务端和客户端程序：</p><ul><li>server端：</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PIPEFILE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">./fifo</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkfifo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 600</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${PIPEFILE}     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#创建一个命名管道，并设置文件权限</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">process_line</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">] process here ..&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Server Started ...&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                      #外循环不断监控管道是否有数据写入</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> read</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> line</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          #按行读取数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">       name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">line</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cut</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;,&quot; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-f1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;s/Name://g&#39;)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       process_line</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &amp;   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#开辟子进程处理数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    done</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PIPEFILE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         #阻塞的方式等待数据写入</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">done</span></span></code></pre></div><p>启动服务端：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/study/shell/share$ bash server.sh </span></span>
<span class="line"><span>Server Started ...</span></span></code></pre></div><ul><li>客户端</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PIPEFILE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">./fifo</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;This a message client.&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$@</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PIPEFILE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 向管道发送数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">main</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$@</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span></code></pre></div><p>执行客户端发送消息： <code>bash client.sh &quot;Name:Jack,Age:22,Gender:Man,Desc:null&quot;</code><code>bash client.sh &quot;Name:Jack,Age:22,Gender:Man,Desc:null&quot;</code><code>bash client.sh &quot;Name:Lily,Age:21,Gender:Woman,Desc:null&quot;</code></p><p>查看服务端接收消息：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>[Jack] process here ..</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[Tom] process here ..</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[Lily] process here ..</span></span></code></pre></div><h3 id="_6-3-普通文件传递消息" tabindex="-1">6.3 普通文件传递消息 <a class="header-anchor" href="#_6-3-普通文件传递消息" aria-label="Permalink to &quot;6.3 普通文件传递消息&quot;">​</a></h3><p>命名管道采用阻塞的方式实现进程间同步通信，有时，我们也需要进程间异步通信，即两个进程间不需要阻塞的方式等待消息， 它们之间仅仅是传递一个状态或者是标志。 实现异步用一个简单的普通文件就可以了。 比如， A进程需要实现系统IP的配置，B进程需要实现系统IP的修改，但前提是要求系统IP已经配置好，否则就执行失败；</p><p>那么A进程在执行配置IP成功后，可以将状态写入一个约定的配置文件（可以为空文件，仅做标志位，也可以写入状态内容），写完后A进程就不管了； B进程在执行修改工作时，首先读取配置文件，确认IP配置状态已经成功，然后执行修改过程； 否则可以提示IP尚未配置；</p><h2 id="_7-进程的远程调用" tabindex="-1">7. 进程的远程调用 <a class="header-anchor" href="#_7-进程的远程调用" aria-label="Permalink to &quot;7. 进程的远程调用&quot;">​</a></h2><p>实际工作中，经常会遇到远程调用主机上的命令或脚本， 或者将本地脚本同步到远程主机上进行调用。 这里用到ssh(Secure Shell),前提是双方主机建立了通信连接机制，或者密钥的方式或者输入密码方式进行登录执行；</p><blockquote><p>ssh -nq user@xxx.xxx.xx.xx &quot;commoand line&quot; -n 把 stdin 重定向到 /dev/null (实际上防止从 stdin 读取数据).<br> -q 安静模式. 消除所有的警告和诊断信息. -t 强制分配伪终端. ssh的详细使用说明可以自行man page</p></blockquote><h3 id="_7-1-进程执行简单命令" tabindex="-1">7.1 进程执行简单命令 <a class="header-anchor" href="#_7-1-进程执行简单命令" aria-label="Permalink to &quot;7.1 进程执行简单命令&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/study/shell/share$ ssh fenglg@192.168.122.39 &quot;uname -a&quot;        </span></span>
<span class="line"><span>fenglg@192.168.122.39&#39;s password: </span></span>
<span class="line"><span>Linux fenglg 5.4.50-amd64-desktop #74 SMP Mon Aug 24 20:15:37 CST 2020 x86_64 GNU/Linux</span></span>
<span class="line"><span>test@test-PC:~/work/study/shell/share$</span></span></code></pre></div><ul><li>ssh连接到远程主机，会进入用户家目录，加载环境变量，所以这里运行的系统命令不需要加绝对路径。</li><li>但如果是自己定义的脚本，并且不在家目录下，则需要带上脚本的绝对路径，否则远程shell找不到脚本。</li></ul>`,19)),i("p",null,[i("strong",null,[p(l,{color:"Blue"},{default:h(()=>s[14]||(s[14]=[a("Bash登录模式分为登录和非登录，交互和非交互，不同的模式下对环境变量（如/etc/profile,~/.profile, ~/.bashrc,...)加载是不一样的，详细可见man page，这里不做阐述。")])),_:1})])]),s[25]||(s[25]=n(`<h3 id="_7-2-进程执行多条命令组合" tabindex="-1">7.2 进程执行多条命令组合 <a class="header-anchor" href="#_7-2-进程执行多条命令组合" aria-label="Permalink to &quot;7.2 进程执行多条命令组合&quot;">​</a></h3><p>如果执行多条命令或者更为复杂的逻辑处理，可以使用Shell Here Document（嵌入文档）的方式。</p><p>应当注意：</p><ul><li>1） 命令从 <code>EOF</code>开始，到遇到下一个<code>EOF</code>结束，注意第二个<code>EOF</code>一定要顶行（行开头，不要留空格或其它字符）书写。</li><li>2） 命令中如果包含变量是在远程主机上进行解析，那么本地命令中要加转义’<code>\\</code>’，否则会被认为是本地变量，解析后再发送给远程主机。 如下例，两个<code>EOF</code>之间的命令，对于本地主机就是多行字符串，发送到远程主机才会执行，在发送之前，会对<code>\${ARCH}</code>变量进行解析，由于<code>ARCH</code>未定义和赋值，这里会被解析成空串发送给远程主机，导致后面命令执行出错。 如果加转义<code>\\\${ARCH}</code>后本地不再解析，发送到远程主机后命令执行过程中解析。</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fenglg@192.168.122.39</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ARCH=$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uname</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">echo &quot;--------------------------&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">echo arch=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">{ARCH}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">echo &quot;--------------------------&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">if [ &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">{ARCH}&quot; = x86_64 ]; then</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    dpkg-query -l qemu-user-static</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">fi</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">echo &quot;--------------------------&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ifconfig | grep -w inet</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span></code></pre></div><p>输出</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>fenglg@192.168.122.39&#39;s password: </span></span>
<span class="line"><span>请输入密码</span></span>
<span class="line"><span>验证成功</span></span>
<span class="line"><span>Welcome to Deepin 20 GNU/Linux</span></span>
<span class="line"><span>--------------------------</span></span>
<span class="line"><span>arch=x86_64</span></span>
<span class="line"><span>--------------------------</span></span>
<span class="line"><span>dpkg-query: 没有找到与 qemu-user-static 相匹配的软件包</span></span>
<span class="line"><span>--------------------------</span></span>
<span class="line"><span>        inet 192.168.122.39  netmask 255.255.255.0  broadcast 192.168.122.255</span></span>
<span class="line"><span>        inet 192.168.122.237  netmask 255.255.255.0  broadcast 192.168.122.255</span></span>
<span class="line"><span>        inet 127.0.0.1  netmask 255.0.0.0</span></span></code></pre></div><h3 id="_7-3-本地脚本远程执行" tabindex="-1">7.3 本地脚本远程执行 <a class="header-anchor" href="#_7-3-本地脚本远程执行" aria-label="Permalink to &quot;7.3 本地脚本远程执行&quot;">​</a></h3><p>把上例的命令写入脚本中，这里把变量<code>$</code>符号之前的转义符给去掉，因它不是在作为字符串传递给远程主机了。 <code>vim remote_shell.sh</code></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ARCH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uname</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;--------------------------&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> arch=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\${ARCH}</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;--------------------------&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ARCH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x86_64 ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    dpkg-query</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -l</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> qemu-user-static</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fi</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;--------------------------&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ifconfig</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -w</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> inet</span></span></code></pre></div><ul><li>把本地脚本拷贝到远程目录下，再通过ssh远程执行。</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/study/shell/share$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">scp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> remote_shell.sh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  fenglg@192.168.122.39:/home/fenglg/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fenglg@192.168.122.39</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&#39;s password: </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">remote_shell.sh                                                        100%  244    85.0KB/s   00:00  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh -nq fenglg@192.168.122.39 &quot;bash -l /home/fenglg/remote_shell.sh&quot;</span></span></code></pre></div><p>输出：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fenglg@192.168.122.39</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&#39;s password: </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">--------------------------</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">arch=x86_64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">--------------------------</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dpkg-query: 没有找到与 qemu-user-static 相匹配的软件包</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">--------------------------</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        inet 192.168.122.39  netmask 255.255.255.0  broadcast 192.168.122.255</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        inet 192.168.122.237  netmask 255.255.255.0  broadcast 192.168.122.255</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        inet 127.0.0.1  netmask 255.0.0.0</span></span></code></pre></div><ul><li>通过标准输入重定向的方式将命令传递到远程执行</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/study/shell/share$ ssh fenglg@192.168.122.39  &lt; remote_shell.sh</span></span></code></pre></div><p>输出与上例是一致的，用此方法可以省去将脚本拷贝到远程主机这一步骤。</p><h2 id="_8-信号处理" tabindex="-1">8. 信号处理 <a class="header-anchor" href="#_8-信号处理" aria-label="Permalink to &quot;8. 信号处理&quot;">​</a></h2><h3 id="_8-1-linux信号" tabindex="-1">8.1 Linux信号 <a class="header-anchor" href="#_8-1-linux信号" aria-label="Permalink to &quot;8.1 Linux信号&quot;">​</a></h3><p>使用<code>kill -l</code>可以查看当前系统支持的信号列表。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>test@test-PC:~/work/study/shell/share$ kill -l</span></span>
<span class="line"><span> 1) SIGHUP       2) SIGINT       3) SIGQUIT      4) SIGILL       5) SIGTRAP</span></span>
<span class="line"><span> 6) SIGABRT      7) SIGBUS       8) SIGFPE       9) SIGKILL     10) SIGUSR1</span></span>
<span class="line"><span>11) SIGSEGV     12) SIGUSR2     13) SIGPIPE     14) SIGALRM     15) SIGTERM</span></span>
<span class="line"><span>16) SIGSTKFLT   17) SIGCHLD     18) SIGCONT     19) SIGSTOP     20) SIGTSTP</span></span>
<span class="line"><span>21) SIGTTIN     22) SIGTTOU     23) SIGURG      24) SIGXCPU     25) SIGXFSZ</span></span>
<span class="line"><span>26) SIGVTALRM   27) SIGPROF     28) SIGWINCH    29) SIGIO       30) SIGPWR</span></span>
<span class="line"><span>31) SIGSYS      34) SIGRTMIN    35) SIGRTMIN+1  36) SIGRTMIN+2  37) SIGRTMIN+3</span></span>
<span class="line"><span>38) SIGRTMIN+4  39) SIGRTMIN+5  40) SIGRTMIN+6  41) SIGRTMIN+7  42) SIGRTMIN+8</span></span>
<span class="line"><span>43) SIGRTMIN+9  44) SIGRTMIN+10 45) SIGRTMIN+11 46) SIGRTMIN+12 47) SIGRTMIN+13</span></span>
<span class="line"><span>48) SIGRTMIN+14 49) SIGRTMIN+15 50) SIGRTMAX-14 51) SIGRTMAX-13 52) SIGRTMAX-12</span></span>
<span class="line"><span>53) SIGRTMAX-11 54) SIGRTMAX-10 55) SIGRTMAX-9  56) SIGRTMAX-8  57) SIGRTMAX-7</span></span>
<span class="line"><span>58) SIGRTMAX-6  59) SIGRTMAX-5  60) SIGRTMAX-4  61) SIGRTMAX-3  62) SIGRTMAX-2</span></span>
<span class="line"><span>63) SIGRTMAX-1  64) SIGRTMAX</span></span></code></pre></div><p>其中最常用的是</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>SIGHUP  1      控制终端发现被挂起或控制进程死亡，缺省动作为进程终止。</span></span>
<span class="line"><span>SIGINT  2      键盘终端中断，一般是\`CTRL+C\`，缺省动作为进程终止。</span></span>
<span class="line"><span>SIGQUIT 3      来自键盘的退出信号，一般是\`CTRL+\\\`，缺省动作为进程终止。</span></span>
<span class="line"><span>SIGKILL 9      杀死进程的信号,缺省动作为进程终止,该信号不能捕捉也不能忽略。</span></span>
<span class="line"><span>SIGUSR1 10     用户自定义信号，缺省动作为进程终止。</span></span>
<span class="line"><span>SIGALRM 14     定时时钟中断，缺省动作为进程终止。</span></span>
<span class="line"><span>SIGTERM 15     终止信号，缺省动作为进程终止。</span></span>
<span class="line"><span>SIGSTP  20     停止进程，一般是\`CTRL+Z\`，缺省动作为进程终止，但终止还可恢复。</span></span></code></pre></div><p>进程可以通过三种方式来响应一个信号：</p><ul><li>1）缺省操作，Linux对每种信号都规定了默认行为，一般是中断进程。</li><li>2）捕捉信号，自定义函数进行处理。</li><li>3）忽略信号，即对信号不做任何处理，其中有两个信号不能忽略：<code>SIGKILL</code>及<code>SIGSTOP</code>。</li></ul><h3 id="_8-2-信号的发送和接收" tabindex="-1">8.2 信号的发送和接收 <a class="header-anchor" href="#_8-2-信号的发送和接收" aria-label="Permalink to &quot;8.2 信号的发送和接收&quot;">​</a></h3><p>信号的来源是多样化的，通过<code>kill -l</code>查看信号名称大概可以看到有来源于键盘，有来源于电源，有来源于时钟等等，信号的接收是默认状态的，对于信号的处理linux也规定了默认动作。 在程序本身中，我们也可以自定义发送和捕捉信号，自定义处理捕捉后的行为。</p><h4 id="_8-2-1-trap-捕捉信号。" tabindex="-1">8.2.1 <code>trap</code> 捕捉信号。 <a class="header-anchor" href="#_8-2-1-trap-捕捉信号。" aria-label="Permalink to &quot;8.2.1 \`trap\` 捕捉信号。&quot;">​</a></h4><p><code>trap</code>用于捕捉信号</p><p>用法： <code>trap [-lp] [[arg] sigspec ...]</code></p>`,30)),i("ul",null,[s[20]||(s[20]=n(`<li><p><code>trap &quot;commands&quot; signals</code> 捕捉到<code>signals</code>，执行<code>commands</code>，<code>signals</code>是信号列表，多个信号用空格分开。<code>commands</code>可以是一条Linux指定，也可以是自定义的函数。 如下示例，<code>trap</code>捕捉<code>INT</code>,<code>HUP</code>,<code>QUIT</code>三个信号，捕捉到后打印<code>Catch Ctrl+C,QUIT!</code>，然后执行<code>exit</code>退出进程。</p><p><code>test@test-PC:~/work/study/shell/share$ vi trap1.sh</code></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">trap</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;echo &#39;Catch SIGNAL,quit!&#39;; exit 0&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> INT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> HUP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> QUIT</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">process_function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Program is processing here&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]main process is running ..&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (( i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    process_function</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">done</span></span></code></pre></div><p><code>trap</code>捕捉后的处理是采用了<code>echo</code>和<code>exit</code>两个指令组合，也可以改为在自定义函数中处理。如下,定义<code>catch_singal</code>来替换<code>commands</code>指定，在函数中可以做更复杂的处理过程。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">trap</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> catch_singal</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> INT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> HUP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> QUIT</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">catch_singal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;echo Catch SIGNAL,quit!&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">process_function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Program is processing here&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]main process is running ..&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (( i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    process_function</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">done</span></span></code></pre></div><p>在上述脚本执行过程中，按下键盘<code>Ctrl</code>+<code>Z</code>，或者执行<code>kill -1 &lt;PID&gt;</code>或者<code>kill -3 &lt;PID&gt;</code>发送信号， 脚本捕捉到信号后做出处理。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/study/shell/share$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> trap1.sh</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4007</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]main process is running ..</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Program</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> processing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> here</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Program</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> processing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> here</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">^CCatch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SIGNAL,quit!</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/study/shell/share$</span></span></code></pre></div></li>`,1)),i("li",null,[i("p",null,[s[16]||(s[16]=i("code",null,'trap "" signals',-1)),s[17]||(s[17]=a(": 忽略信号signals，即捕捉到信号，不做处理，屏蔽掉缺省的行为。")),i("strong",null,[p(l,{color:"Red"},{default:h(()=>s[15]||(s[15]=[a("注意："),i("code",null,"SIGKILL",-1),a(","),i("code",null,"SIGSTOP",-1),a("不能被忽略，缺省的操作必定执行。")])),_:1})]),s[18]||(s[18]=a(" 仍然用上例，"))]),s[19]||(s[19]=n(`<div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">trap</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> INT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> HUP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> QUIT</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">process_function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Program is processing here&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]main process is running ..&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (( i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    process_function</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">done</span></span></code></pre></div><p>任凭如何按<code>Ctrl</code>+<code>C</code>，进程都要执行完毕才退出。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6712</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]main process is running ..</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Program</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> processing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> here</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">^C^C^CProgram</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> processing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> here</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">^C^C^C^C^CProgram</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> processing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> here</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">^C^C^CProgram</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> processing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> here</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">^C^CProgram</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> processing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> here</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/study/shell/share$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">^C</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/study/shell/share$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">^C</span></span></code></pre></div><p>当然，你也可以在<code>trap &quot;&quot;</code>的打印一段信息，表示已接收到信号，如<code>trap &quot;echo &#39;Catch Ctrl+C,but ignore it.&#39;&quot; INT HUP QUIT</code>，然后再次执行，进程接收到了键盘中断信号，但是不鸟它，就是这么豪横。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/study/shell/share$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> trap2.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7599</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]main process is running ..</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Program</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> processing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> here</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">^CCatch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ctrl+C,but</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ignore</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> it.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Program</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> processing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> here</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Program</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> processing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> here</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">^CCatch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ctrl+C,but</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ignore</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> it.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Program</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> processing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> here</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">^CCatch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ctrl+C,but</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ignore</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> it.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Program</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> processing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> here</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/study/shell/share$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">^C</span></span></code></pre></div>`,5))]),s[21]||(s[21]=n(`<li><p><code>trap signals</code>: 恢复信号的默认行为。 信号可以在进程的开头部分进行忽略，保证进程的关键操作能够不受影响得以完成，也可以中间部分恢复信号的默认行为，保证进程能够正常接收处理信号 。 <code>test@test-PC:~/work/study/shell/share$ vi trap3.sh </code></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">trap</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;echo &#39;Catch Ctrl+C,but ignore it.&#39;&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> INT</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[1]main process is running ..&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[2]main process is running ..&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[3]main process is running ..&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">trap</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> INT</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[4]main process is running ..&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[5]main process is running ..&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[6]main process is running ..&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span></code></pre></div><p>执行前三次打印，发送中断信号无效，第四打印，中断信号成功。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/study/shell/share$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> trap3.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]main process is running ..</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">^CCatch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ctrl+C,but</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ignore</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> it.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]main process is running ..</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">^CCatch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ctrl+C,but</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ignore</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> it.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]main process is running ..</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">^CCatch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ctrl+C,but</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ignore</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> it.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]main process is running ..</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">^C</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/study/shell/share$</span></span></code></pre></div></li><li><p><code>trap -p signal</code>: 把当前的trap设置打印出来。</p></li><li><p><code>trap -l</code>:打印系统支持的信号列表。同<code>kill -l</code>。</p></li><li><p><code>trap &quot;commands&quot; EXIT</code>:脚本退出时执行commands指定的命令。</p></li><li><p><code>trap &quot;commands&quot; RETURN</code>:当从shell函数返回、或者使用source命令执行另一个脚本文件时，执行commands指定的命令。</p></li>`,5))]),s[26]||(s[26]=n(`<h4 id="_8-2-2-kill-发送信号。" tabindex="-1">8.2.2 <code>kill</code> 发送信号。 <a class="header-anchor" href="#_8-2-2-kill-发送信号。" aria-label="Permalink to &quot;8.2.2 \`kill\` 发送信号。&quot;">​</a></h4><p><code>kill</code>:发送信号 用法 ：<code>kill[-ssignal|-p][-a]pid...</code></p><blockquote><p>-s 指定发送的信号. 信号可以以信号名或数字的方式给定。 -p 指定 kill 只打印命名进程的进程标识 (pid) , 而不应发送给它信号。 -l 打印信号名的列表.这可以在 /usr/include/linux/signal.h 中找到。 pid ... 给 kill 指定一个该发信号的进程列表。</p></blockquote><ul><li><p><code>kill &lt;signal&gt; &lt;pids&gt;</code>: 发送<code>kill</code>和接收<code>trap</code>信号时，<code>signal</code>可以使用信号名或数字， 信号名可以带前缀<code>SIG</code>,如<code>SIGHUP</code>，也可以不带，如<code>HUP</code>。<code>pids</code>进程ID可为多个，用空格分隔。 最常用的发送<code>SIGKILL</code>信号来杀死进程,通过命令的返回码<code>$?</code>判断是否执行成功，成功则为<code>0</code>，否则失败。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/code/rootfs_mate$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -9</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 21291</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/code/rootfs_mate$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $?</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/code/rootfs_mate$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -9</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 81291</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-bash:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kill:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (81291) - 没有那个进程</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/code/rootfs_mate$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $?</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1</span></span></code></pre></div></li><li><p><code>kill pid</code>： <code>kill</code>不带信号名或数字，则发送<code>(15)SIGTERM</code>信号，默认中断进程。</p></li><li><p><code>kill -0 pid</code>: 或<code>kill -EXIT pid</code>，常用于查询进程在后台是否还在运行，通过命令的返回码<code>$?</code>来判断，如果<code>$?</code>为<code>0</code>说明进程还在，否则，进程已经退出。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/study/shell/share$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 31496</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/study/shell/share$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $?</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/study/shell/share$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 51496</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bash:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kill:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (51496) - 没有那个进程</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/study/shell/share$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $?</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1</span></span></code></pre></div></li></ul><h3 id="_8-3-进程通过信号通信" tabindex="-1">8.3 进程通过信号通信 <a class="header-anchor" href="#_8-3-进程通过信号通信" aria-label="Permalink to &quot;8.3 进程通过信号通信&quot;">​</a></h3><p>练习信号通信，使用一个自定义信号<code>SIGUSR1</code>来给守护进程增加一个退出机制。通过自定义函数，保证程序做完清理，然后安全的退出。 <code>test@test-PC:~/work/study/shell/share$ vi server.sh </code></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PIPEFILE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">./fifo</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $PIPEFILE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkfifo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 600</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${PIPEFILE}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">trap</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> signal_quit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> USR1</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #监听USR1信号</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()        </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Clean unuse Env&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Clear unuse files&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">signal_quit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()            #信号处理函数，接收到USR1信号时做程序的清理动作，然后退出。</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Catch quit sigal, clean and quit!&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    clean</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">process_line</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">] process here ..&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]Server Started ...&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> read</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> line</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">       name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">line</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cut</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;,&quot; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-f1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;s/Name://g&#39;)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       process_line</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &amp;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    done</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PIPEFILE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">done</span></span></code></pre></div><p>写一个客户端进程，专门用来安全停止<code>server.sh</code>服务进程。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ps</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -u</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fenglg </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-ef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -w</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> server.sh  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -v</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -E</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vi|grep&#39; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> awk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{print $2}&#39;)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     #查询到server.sh的进程id</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Stopping [</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$pid</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">][server.sh] ...&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pid</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x ];</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (( i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#安全退出时间限制为3秒，3秒后如未退出，则强制杀死</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    do</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -EXIT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${pid} &amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/dev/null  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#查询进程是否退出</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$?</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -eq</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ];</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -USR1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${pid}  &amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/dev/null   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#发送信号给server.sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        else</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;  [OK]&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        fi</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    done</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -KILL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${pid}     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#3秒后还未退出，强制杀死进程（补充不安全退出）</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;  [OK]&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;server.sh already exited!&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fi</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span></code></pre></div><p><code>stopserver.sh</code>执行结果：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/code/rootfs_mate$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stopserver.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Stopping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [2563][server.sh] ...  [OK]</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/code/rootfs_mate$</span></span></code></pre></div><p><code>server.sh</code>执行结果：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/study/shell/share$ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> server.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2563</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]Server Started ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Catch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> quit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sigal,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clean</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> and</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> quit!</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Clean</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> unuse</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Env</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Clear</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> unuse</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> files</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PC:~/work/study/shell/share$</span></span></code></pre></div>`,13))])}const B=e(r,[["render",F]]);export{u as __pageData,B as default};
